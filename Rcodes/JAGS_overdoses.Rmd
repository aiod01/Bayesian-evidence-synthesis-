---
title: "JAGS Model"
author: "Tom Park"
date: '2020-02-08'
output:
  pdf_document: default
  html_document: default
---
## Basic Model: Ambulance + Overdose
### Ambulance Call-outs Model
$n_{A}$: sample size   
$x_{A}$: the total number who confirmed they did call an ambulance  
$p_{A}$: probability of a person call an ambulance   
$$x_{A} \sim Bin(n_{A},p_{A})$$
**We assume $n_{A}=1000, p_A = 0.8$.**  
**Suppose the prior of $p_A$ is noninformative.** 
$$p(p_A) \sim Beta(1,1)$$
  
### Overdose Model  
Now we plug in this values into the overdose model and obtain possible $O_t$ values **assuming we have $U_t$ values.**

Also, we have priors.
$$z_{t} \sim N(\mu, \sigma^{2})$$
$$\lambda_{t}^{OD} = \exp(z_{t})$$
$$O_{t} \sim Poi(\lambda_{t}^{OD}N)$$
$$U_t \sim Bin(O_t, p_A)$$
For simplicity we set N =10000 for now. We need to generate reasonable $U_t$ values first. Note that $U_t$ comes from $\mu, \sigma$ following all the way through the overdose model.  
$\mu=\log0.05, \sigma=1, N=10000$.   
We suppose survey data exists: ($n_A, x_A$) known.  

**We set for our prior parameters:** $$\mu \sim U(-10,0)$$  $$\sigma \sim U(0,5)$$


```{r message=FALSE, warning=FALSE}
# install packages
if (!require(rjags)) install.packages("rjags", dependencies = TRUE)
if (!require(coda)) install.packages("coda", dependencies = TRUE)
if (!require(tidyverse)) install.packages("tidyverse", dependencies = TRUE)
if (!require(tinytex)) install.packages("tinytex", dependencies = TRUE)

library('rjags')
library('coda')
library('tidyverse')
library('tinytex')

```
The data is the same data from pymc3 with Python.  
Todo: build a pipeline to connect the python (pymc3) and R (JAGS)

```{r}
df <- read.csv('./basic_data.csv')
df$X <- NULL 
head(df)
```
Now we set the model which defines the relations of overdose model and ambulance call model.

The model defined as follows.
```{r Enter the models}
cat("model{
## define the priors
p_a ~ dbeta(alpha, beta)
mu ~ dunif(mu_a, mu_b)
sigma ~ dunif(sigma_a, sigma_b)

## the latent variables
z ~ dnorm(mu, 1/(sigma^2))
lambda <- exp(z)

for (i in 1:n) {
  ## ambulance model 
  x_a[i] ~ dbin(p_a, n_a) # each survey result for month
}
for (i in 1:n) {
  ## overdose model
  o_t[i] ~ dpois(lambda*N) # total overdoses per month
}
for (i in 1:n) {
  u_t[i] ~ dbin(p_a, o_t[i]) # ambulanced overdoses per month
}

}", file='basic_model.txt')
```

Pre-set variables.
```{r Defining Values}
n <-  length(df$o_t) # we have 12 samples
n_a <- 1000
N <- 10000
u_t <- df$u_t
x_a <- df$x_a
```

Define the list providing the values of the variables and the parameters for the priors of the model. 
```{r from variable name to \'variable_name\'}
dat <- list(
            # priors for ambulance model
            'alpha' = 1,
            'beta' =  1, 
            
            # priors for overdose model 
            'mu_a'=(-10),
            'mu_b'=0,
            'sigma_a'=0,
            'sigma_b'=5,
            
            # likelihood 
            'u_t'=u_t, 
            'x_a'=x_a,  
            'N'=N, # the population
            'n'= n, # total months
            'n_a'=n_a
            
            )
```
**Note: for the list object usually named 'data' or 'dat' in JAGS context, do not use arrow but use equal sign to define elements of the list.**
``` {r run the first model without error }
interations = 1000
burnin= floor(interations/2)
chains=2
# inits = list()
simple.model <- jags.model(file='basic_model.txt',
                          data=dat,
                          n.chains = chains)
simple.model
```

### O_t

```{r}
params= c('o_t')
samples <- coda.samples(simple.model, params, n.iter = 1000)
```

# Q1: is init necessary? and it's a characteristic of Gibbs sampling?

```{r }
summary(window(samples), start=burnin)
```

```{r include=FALSE}
plot(samples)
```

### Boxplots of O_t

# q2: I see two elements from the samples list. Which one I should use it or should I use both?

```{r yield a data frame}
temp = as.matrix(samples)
colnames(temp) <- seq(1,12)
head(temp)
df_o_t <- as.data.frame(temp)
head(df_o_t)
```


```{r tidy the data frame}
df_o_t <- gather(df_o_t, key = 'month',value = 'o_t')
df_o_t$month <- factor(df_o_t$month,levels = seq(1,12))
str(df_o_t)
```

```{r}
o_t_values=data.frame('month'=seq(1,12),'o_t'=df$o_t)
o_t_values$month <- factor(o_t_values$month,levels = seq(1,12))

ggplot()+geom_point(aes(x=o_t_values$month, y=o_t_values$o_t),color='red')+geom_boxplot(aes(x=month,y=o_t),data = df_o_t)
```

```{r}
params= c('u_t','x_a')
ppc <- coda.samples(simple.model, params, n.iter = 1000)
```

```{r}
summary(window(ppc),start=burnin)

```

```{r eval=FALSE, include=FALSE}
plot(ppc)
```

```{r}
temp = as.matrix(ppc)

df_u_t=temp[,1:12]
df_x_a=temp[,13:24]


test <- as.matrix(df_u_t)
colnames(test) <- seq(1,12)
head(test)
mtx_u_t <- as.data.frame(test)
head(mtx_u_t)

df_u_t <- gather(mtx_u_t, key = 'month',value = 'u_t')
head(df_u_t)

df_u_t$month <- factor(df_u_t$month,levels = seq(1,12))
str(df_u_t)

u_t_values=data.frame('month'=seq(1,12),'u_t'=df$u_t)
u_t_values$month <- factor(u_t_values$month,levels = seq(1,12))

ggplot()+geom_point(aes(x=u_t_values$month, y=u_t_values$u_t),color='red')+geom_boxplot(aes(x=month,y=u_t),data = df_u_t)
```

```{r}

temp = as.matrix(ppc)
df_x_a=temp[,13:24]


test <- as.matrix(df_x_a)
colnames(test) <- seq(1,12)
head(test)
mtx_x_a <- as.data.frame(test)
head(mtx_x_a)

df_x_a <- gather(mtx_x_a, key = 'month',value = 'x_a')
head(df_x_a)

df_x_a$month <- factor(df_x_a$month,levels = seq(1,12))
str(df_x_a)

x_a_values=data.frame('month'=seq(1,12),'x_a'=df$x_a)
x_a_values$month <- factor(x_a_values$month,levels = seq(1,12))

ggplot()+geom_point(aes(x=x_a_values$month, y=x_a_values$x_a),color='red')+geom_boxplot(aes(x=month,y=x_a),data = df_x_a)
```



## Reference 
[first tutorial](https://www.youtube.com/watch?v=F9jxvhXc_1w)  
[second tutorial](https://rstudio-pubs-static.s3.amazonaws.com/272658_ae4d482c86514674be17042c852ebbfc.html)   
[JAGS manual](https://web.sgh.waw.pl/~atoroj/ekonometria_bayesowska/jags_user_manual.pdf)   
[error handling guide](https://www4.stat.ncsu.edu/~reich/ABA/code/errors)  
